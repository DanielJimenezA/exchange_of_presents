<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Admin - Exchange of Presents</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
<link href="static/styles.css" rel="stylesheet">
</head>

<body>
<div class="container mt-4">

  <div class="text-end mb-3">
    <button class="btn btn-sm btn-outline-secondary" onclick="setLanguage('es')" data-i18n="lang_es"></button>
    <button class="btn btn-sm btn-outline-secondary" onclick="setLanguage('en')" data-i18n="lang_en"></button>
  </div>

  <div class="text-center mb-4">
    <h1 class="titulo-navidad" data-i18n="a_title"></h1>
    <p class="subtitulo-navidad" data-i18n="a_subtitle"></p>
  </div>

  <div class="card shadow">
    <div class="card-header bg-warning fw-bold" data-i18n="a_adminPanel"></div>

    <div class="card-body">
      <button class="btn btn-navidad btn-lg mb-3" onclick="generar()" data-i18n="a_generateId"></button>

      <div class="mb-3">
        <label class="fw-bold" data-i18n="a_exchangeId"></label>
        <div class="input-group">
          <input id="id" class="form-control text-center fw-bold" readonly>
          <button class="btn btn-outline-secondary" onclick="copiar('id')" data-i18n="a_copy"></button>
        </div>
      </div>

      <div class="mb-3">
        <label class="fw-bold" data-i18n="a_participantLink"></label>
        <div class="input-group">
          <input id="link" class="form-control" readonly>
          <button class="btn btn-outline-secondary" onclick="copiar('link')" data-i18n="a_copy"></button>
          <button class="btn btn-outline-success" onclick="abrirLink()" data-i18n="a_open"></button>
        </div>
        <div class="form-text">
          Backend URL: <code id="backendUrl"></code> &nbsp;|&nbsp;
          <a href="#" onclick="cambiarBackend(); return false;">Change</a>
        </div>
      </div>

      <div class="mb-3 text-center">
        <p class="fw-bold" data-i18n="a_qrTitle"></p>
        <img id="qr" class="img-fluid border rounded p-2" style="max-width:200px;">
      </div>

      <div class="alert alert-info fw-bold">
        <span data-i18n="a_registeredCount"></span>: <span id="contador">0</span>
      </div>

      <div class="d-flex flex-wrap gap-2 justify-content-center">
        <button class="btn btn-danger" onclick="cerrarIntercambio()" data-i18n="a_closeExchange"></button>
        <button class="btn btn-primary" onclick="realizarSorteo()" data-i18n="a_runDraw"></button>
        <button class="btn btn-success" onclick="exportarExcel()" data-i18n="a_exportExcel"></button>
      </div>

      <div id="toast" class="text-success fw-bold mt-3 d-none"></div>
    </div>
  </div>

  <div class="card shadow mt-4">
    <div class="card-header bg-success text-white fw-bold" data-i18n="a_registeredList"></div>
    <div class="card-body table-responsive">
      <table class="table table-bordered table-sm align-middle text-center">
        <thead class="table-light">
          <tr>
            <th data-i18n="a_col_num"></th>
            <th data-i18n="a_col_name"></th>
            <th data-i18n="a_col_whatsapp"></th>
            <th data-i18n="a_col_gifts"></th>
          </tr>
        </thead>
        <tbody id="tablaParticipantesAdmin">
          <tr>
            <td colspan="4" class="text-muted" data-i18n="a_noParticipants"></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card shadow mt-4">
    <div class="card-header bg-danger text-white fw-bold" data-i18n="a_drawPanel"></div>
    <div class="card-body table-responsive">
      <table class="table table-bordered align-middle text-center">
        <thead class="table-light">
          <tr>
            <th data-i18n="a_col_num"></th>
            <th data-i18n="a_col_giver"></th>
            <th data-i18n="a_col_receiver"></th>
            <th data-i18n="a_col_action"></th>
          </tr>
        </thead>
        <tbody id="tablaSorteoFinal">
          <tr>
            <td colspan="4" class="text-muted" data-i18n="a_draw_none"></td>
          </tr>
        </tbody>
      </table>
      <div class="text-muted small" data-i18n="a_bulkSendHint"></div>
    </div>
  </div>

  <div class="footer-navidad text-center mt-4">
    游꾻 Exchange of Presents 游꾸
  </div>
</div>

<script src="static/i18n.js"></script>
<script src="static/lang.js"></script>
<script src="static/config.js"></script>

<script>
let intercambioId = "";

// build API URL
function api(path) {
  return `${window.BACKEND_BASE_URL}${path}`;
}

function toast(msgKey) {
  const el = document.getElementById("toast");
  el.textContent = t(msgKey);
  el.classList.remove("d-none");
  setTimeout(() => el.classList.add("d-none"), 2000);
}

function cambiarBackend() {
  const val = prompt("Set backend URL (e.g. https://...)", window.BACKEND_BASE_URL);
  if (!val) return;
  localStorage.setItem("backend_url", val.trim());
  location.reload();
}

function generar(){
  intercambioId = "NAV-" + crypto.randomUUID().slice(0,8).toUpperCase();
  const base = location.origin + location.pathname.replace(/\/[^\/]*$/, "/");
  const link = base + "participante.html?id=" + intercambioId;

  document.getElementById("id").value = intercambioId;
  document.getElementById("link").value = link;

  document.getElementById("qr").src =
    "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" +
    encodeURIComponent(link);

  document.getElementById("backendUrl").textContent = window.BACKEND_BASE_URL;

  actualizarContador();
  cargarParticipantes();
  resetSorteoTable();
}

function copiar(elementId){
  const val = document.getElementById(elementId).value;
  navigator.clipboard.writeText(val).then(() => toast("a_copy_ok"));
}

function abrirLink(){
  const link = document.getElementById("link").value;
  if (link) window.open(link, "_blank");
}

function actualizarContador(){
  if (!intercambioId) return;
  fetch(api(`/api/intercambio/${intercambioId}/contador`))
    .then(r => r.json())
    .then(d => document.getElementById("contador").textContent = d.total)
    .catch(() => {});
}

function cargarParticipantes(){
  if (!intercambioId) return;
  fetch(api(`/api/intercambio/${intercambioId}/participantes`))
    .then(r => r.json())
    .then(data => {
      const tbody = document.getElementById("tablaParticipantesAdmin");
      tbody.innerHTML = "";

      if (!data || data.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="4" class="text-muted">${t("a_noParticipants")}</td>`;
        tbody.appendChild(tr);
        return;
      }

      data.forEach((p, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${p.nombre}</td>
          <td>${p.whatsapp}</td>
          <td>游꾸 ${p.regalos[0] || ""}<br>游꾸 ${p.regalos[1] || ""}<br>游꾸 ${p.regalos[2] || ""}</td>
        `;
        tbody.appendChild(tr);
      });
    })
    .catch(() => {});
}

function resetSorteoTable() {
  const tbody = document.getElementById("tablaSorteoFinal");
  tbody.innerHTML = `<tr><td colspan="4" class="text-muted">${t("a_draw_none")}</td></tr>`;
}

function realizarSorteo(){
  if (!intercambioId) { alert(t("a_need_id")); return; }

  fetch(api(`/api/intercambio/${intercambioId}/sorteo`))
    .then(async r => {
      if (!r.ok) throw new Error();
      return r.json();
    })
    .then(data => {
      const tbody = document.getElementById("tablaSorteoFinal");
      tbody.innerHTML = "";

      if (!data || data.length === 0) {
        resetSorteoTable();
        return;
      }

      fetch(api(`/api/intercambio/${intercambioId}/participantes`))
        .then(r => r.json())
        .then(participantes => {
          const giftsByName = new Map(participantes.map(p => [p.nombre, p.regalos]));

          data.forEach((r, i) => {
            const regalosRecibe = giftsByName.get(r.recibe) || ["", "", ""];
            const mensaje = [
              t("wa_header"),
              `${t("wa_hi")} ${r.da}!`,
              `${t("wa_you_give_to")}: ${r.recibe}`,
              "",
              `${t("wa_gift_options")}:`,
              `游꾸 ${regalosRecibe[0] || ""}`,
              `游꾸 ${regalosRecibe[1] || ""}`,
              `游꾸 ${regalosRecibe[2] || ""}`,
              "",
              t("wa_thanks")
            ].join("\n");

            const link = `https://wa.me/${r.whatsapp}?text=${encodeURIComponent(mensaje)}`;

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${i + 1}</td>
              <td>${r.da}</td>
              <td>${r.recibe}</td>
              <td>
                <a class="btn btn-success btn-sm" target="_blank" href="${link}">
                  ${t("a_sendWhatsapp")}
                </a>
              </td>
            `;
            tbody.appendChild(tr);
          });
        });
    })
    .catch(() => alert(t("a_draw_error_min")));
}

function cerrarIntercambio(){
  if (!intercambioId) { alert(t("a_need_id")); return; }
  if (!confirm(t("a_confirm_close"))) return;

  fetch(api(`/api/intercambio/${intercambioId}/cerrar`), { method: "POST" })
    .then(r => {
      if (!r.ok) throw new Error();
      alert(t("a_closed_ok"));
    })
    .catch(() => alert("Error"));
}

function exportarExcel(){
  if (!intercambioId) { alert(t("a_need_id")); return; }
  window.open(api(`/api/intercambio/${intercambioId}/excel`), "_blank");
}

setInterval(() => {
  actualizarContador();
  cargarParticipantes();
}, 5000);

window.onLanguageChanged = () => {
  if (!intercambioId) return;
  cargarParticipantes();
  const tbody = document.getElementById("tablaSorteoFinal");
  if (tbody && !tbody.querySelector("a.btn")) resetSorteoTable();
};

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("backendUrl").textContent = window.BACKEND_BASE_URL;
});
</script>

</body>
</html>
